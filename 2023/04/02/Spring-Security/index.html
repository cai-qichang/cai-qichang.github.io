

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <!-- 通过 CDN 引入霞鹜文楷字体 -->
  <link rel="stylesheet" href="https://npm.elemecdn.com/lxgw-wenkai-screen-webfont/style.css" media="print" onload="this.media='all'">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/me.png">
  <link rel="icon" href="/img/me.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="caiqichang">
  <meta name="keywords" content="">
  
    <meta name="description" content="Spring securitySpring Security官网  认证 Authentication几个登陆认证重要的组件： SecurityContextHolder：Spring Security存储安全身份验证者详细信息的位置。  使用ThreadLocal实现  SecurityContext：从SecurityContextHolder获得，并包含当前经过身份验证的用户的身份验证。 A">
<meta property="og:type" content="article">
<meta property="og:title" content="Spring Security">
<meta property="og:url" content="https://cai-qichang.github.io/2023/04/02/Spring-Security/index.html">
<meta property="og:site_name" content="caiqichang&#39;s Blog">
<meta property="og:description" content="Spring securitySpring Security官网  认证 Authentication几个登陆认证重要的组件： SecurityContextHolder：Spring Security存储安全身份验证者详细信息的位置。  使用ThreadLocal实现  SecurityContext：从SecurityContextHolder获得，并包含当前经过身份验证的用户的身份验证。 A">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://raw.githubusercontent.com/cai-qichang/cqc-photo/master/img/spring-security.jpg">
<meta property="og:image" content="https://raw.githubusercontent.com/cai-qichang/cqc-photo/master/img/abstractauthenticationprocessingfilter.png">
<meta property="og:image" content="https://raw.githubusercontent.com/cai-qichang/cqc-photo/master/img/Cookies-attack.jpg">
<meta property="og:image" content="https://docs.spring.io/spring-security/site/docs/current/reference/html5/images/servlet/authorization/filtersecurityinterceptor.png">
<meta property="og:image" content="https://raw.githubusercontent.com/cai-qichang/cqc-photo/master/img/0a6b437fe2034d44a393998ef4bf173a.png">
<meta property="article:published_time" content="2023-04-02T11:51:00.000Z">
<meta property="article:modified_time" content="2024-10-13T05:21:07.991Z">
<meta property="article:author" content="caiqichang">
<meta property="article:tag" content="Spring Security">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://raw.githubusercontent.com/cai-qichang/cqc-photo/master/img/spring-security.jpg">
  
  
    <meta name="referrer" content="no-referrer-when-downgrade">
  
  
  <title>Spring Security - caiqichang&#39;s Blog</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"cai-qichang.github.io","root":"/","version":"1.9.5","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"follow_dnt":true,"baidu":null,"google":{"measurement_id":null},"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml","include_content_in_search":true};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  


  
<meta name="generator" content="Hexo 6.3.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>caiqichang</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                <span>首页</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                <span>归档</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                <span>分类</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                <span>标签</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                <span>关于</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/yueqiu.jpg') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="Spring Security"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2023-04-02 19:51" pubdate>
          2023年4月2日 晚上
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          23k 字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          193 分钟
        
      </span>
    

    
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <h1 id="seo-header">Spring Security</h1>
            
            
              <div class="markdown-body">
                
                <h1 id="Spring-security"><a href="#Spring-security" class="headerlink" title="Spring security"></a>Spring security</h1><p><a target="_blank" rel="noopener" href="https://docs.spring.io/spring-security/site/docs/5.4.2/reference/html5/#servlet-architecture">Spring Security官网</a></p>
<p><img src="https://raw.githubusercontent.com/cai-qichang/cqc-photo/master/img/spring-security.jpg" srcset="/img/loading.gif" lazyload alt="avatar"></p>
<h2 id="认证-Authentication"><a href="#认证-Authentication" class="headerlink" title="认证 Authentication"></a>认证 Authentication</h2><p>几个登陆认证重要的组件：</p>
<p>SecurityContextHolder：Spring Security存储安全身份验证者详细信息的位置。</p>
<blockquote>
<p>使用ThreadLocal实现</p>
</blockquote>
<p>SecurityContext：从SecurityContextHolder获得，并包含当前经过身份验证的用户的身份验证。</p>
<p>Authentication：是AuthenticationManager的输入，以提供用户提供的用于身份验证的凭据。</p>
<p>GrantedAuthority：授予身份验证主体的权限（即角色，作用域等）</p>
<p>AuthenticationManager：定义Spring Security的过滤器如何执行身份验证的API。</p>
<p>ProviderManager：AuthenticationManager的最常见实现，委托给一个 AuthenticationProviders 列表，每个AuthenticationProviders都可以验证登陆成功或者失败，如果没有一个 AuthenticationProvider验证通过， 那么会抛出ProviderNotFoundException。</p>
<p>AuthenticationProvider：可以通过supportType指定不同类型的认证的，比如账号密码的认证、token的认证等等。</p>
<p>AuthenticationEntryPoint：用于返回从客户端请求的 HTTP 响应（比如未认证的请求自动跳转、或者自己实现重定向到登录页面，发送WWW身份验证响应等）</p>
<p>AbstractAuthenticationProcessingFilter：用作验证用户凭据的基本过滤器。 在验证前，Spring Security 通常使用 AuthenticationEntryPoint 请求凭据。</p>
<p>UserDetailsService: spring security 默认提供的用户密码登陆接口。</p>
<h3 id="整体流程"><a href="#整体流程" class="headerlink" title="整体流程"></a>整体流程</h3><p><img src="https://raw.githubusercontent.com/cai-qichang/cqc-photo/master/img/abstractauthenticationprocessingfilter.png" srcset="/img/loading.gif" lazyload alt="image"><br>以下是流程解释的英文原文：</p>
<ol>
<li><p>When the user submits their credentials, the AbstractAuthenticationProcessingFilter creates an Authentication from the HttpServletRequest to be authenticated. The type of Authentication created depends on the subclass of AbstractAuthenticationProcessingFilter. For example, UsernamePasswordAuthenticationFilter creates a UsernamePasswordAuthenticationToken from a username and password that are submitted in the HttpServletRequest.</p>
</li>
<li><p>Next, the Authentication is passed into the AuthenticationManager to be authenticated.</p>
</li>
<li><p>If authentication fails, then Failure <br>The SecurityContextHolder is cleared out.<br>RememberMeServices.loginFail is invoked. If remember me is not configured, this is a no-op.<br>AuthenticationFailureHandler is invoked.</p>
</li>
<li><p>If authentication is successful, then Success.<br>SessionAuthenticationStrategy is notified of a new log in.<br>The Authentication is set on the SecurityContextHolder. Later the SecurityContextPersistenceFilter saves the SecurityContext to the HttpSession.<br>RememberMeServices.loginSuccess is invoked. If remember me is not configured, this is a no-op.<br>ApplicationEventPublisher publishes an InteractiveAuthenticationSuccessEvent.<br>AuthenticationSuccessHandler is invoked.</p>
</li>
</ol>
<p>大流程:</p>
<ol>
<li><p>AbstractAuthenticationProcessingFilter 过滤器从HttpServletRequest获取认证的标识，根据标识创建Authentication。具体创建何种类型的Authentication，自己通过继承AbstractAuthenticationProcessingFilter去实现</p>
<ul>
<li><blockquote>
<p>比如UsernamePasswordAuthenticationFilter 创建的Authentication类型是UsernamePasswordAuthenticationToken</p>
</blockquote>
</li>
</ul>
</li>
<li><p>Authentication传递到AuthenticationManager进行认证，ProviderManager会通过委托到支持具体该类型Authentication的AuthenticationProvider</p>
</li>
<li><p>AuthenticationProvider进行认证，认证成功</p>
</li>
</ol>
<h3 id="基于session认证"><a href="#基于session认证" class="headerlink" title="基于session认证"></a>基于session认证</h3><p>默认的security认证是基于username的session认证</p>
<p>第一次访问：</p>
<ol>
<li>首先进入应用页面 SecurityContextPersistenceFilter会获取HttpSessionSecurityContextRepository#loadContext 获取cookies中的session，第一次进入jsessionId未空</li>
<li>AbstractAuthenticationProcessingFilter.requiresAuthentication 判读是否需要验证,第一次进入页面为GET方法，而认证仅支持POST方式。</li>
<li>DefaultLoginPageGeneratingFilter跳转登陆页面。我们cookies中增加了JsessionID</li>
</ol>
<p>第二次访问</p>
<ol>
<li>登陆页面输入账号密码 SecurityContextPersistenceFilter会获取HttpSessionSecurityContextRepository#loadContext 获取cookies中的session，第一次进入jsessionId未空</li>
<li>AbstractAuthenticationProcessingFilter.requiresAuthentication 判读是否需要验证,调用UsernamePasswordAuthenticationFilter的attemptAuthentication</li>
<li>AbstractUserDetailsAuthenticationProvider 进行账户密码认证，将认证成功的加入到sessionContext中</li>
</ol>
<p>第三次访问</p>
<ol>
<li>SecurityContextPersistenceFilter根据JSESSIONID会获取HttpSessionSecurityContextRepository，发现该sessionId已认证pass</li>
</ol>
<h2 id="授权-Authorization"><a href="#授权-Authorization" class="headerlink" title="授权 Authorization"></a>授权 Authorization</h2><h3 id="基于注解"><a href="#基于注解" class="headerlink" title="基于注解"></a>基于注解</h3><p>使用注解标注方法是否有权限</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs less"><span class="hljs-variable">@PreAuthorize</span>(<span class="hljs-string">&quot;hasRole(&#x27;USER&#x27;)&quot;</span>)<br><span class="hljs-variable">@PostFilter</span>(<span class="hljs-string">&quot;hasPermission(filterObject, &#x27;read&#x27;) or hasPermission(filterObject, &#x27;admin&#x27;)&quot;</span>)<br>public List&lt;Contact&gt; <span class="hljs-built_in">getAll</span>();<br></code></pre></td></tr></table></figure>

<h3 id="使用配置添加权限"><a href="#使用配置添加权限" class="headerlink" title="使用配置添加权限"></a>使用配置添加权限</h3><p>另一种做法是在继承WebSecurityConfigurerAdapter时，将url及对应的权限全部load进 httpSecurity中</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">ExpressionUrlAuthorizationConfigurer&lt;HttpSecurity&gt;.ExpressionInterceptUrlRegistry urlRegistry = http.authorize<span class="hljs-constructor">Requests()</span>;<br>Map&lt;String, String&gt; resourcePermissions = permissionService.get<span class="hljs-constructor">ResourcePermissions()</span>;<br><span class="hljs-keyword">for</span> (Map.Entry&lt;String, String&gt; entry : resourcePermissions.entry<span class="hljs-constructor">Set()</span>) &#123;<br>    urlRegistry = urlRegistry.ant<span class="hljs-constructor">Matchers(<span class="hljs-params">entry</span>.<span class="hljs-params">getKey</span>()</span>).has<span class="hljs-constructor">AnyAuthority(<span class="hljs-params">entry</span>.<span class="hljs-params">getValue</span>()</span>);<br>&#125;<br></code></pre></td></tr></table></figure>


<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>使用配置添加权限，相当于需要一大部分的工作量配置角色对应的权限。</p>
<ul>
<li>好处：数据库显示前台表统一管理。</li>
<li>坏处：配置工作量大，每个角色均需要配置。新增加接口需要新增加数据库记录。</li>
</ul>
<p>基于注解配置权限</p>
<ul>
<li>好处：开发人员即可配置权限，配置简单。</li>
<li>缺点：权限散落在各个接口中，不利于统一管理。</li>
</ul>
<h2 id="Session-与-Cookies-认证"><a href="#Session-与-Cookies-认证" class="headerlink" title="Session 与 Cookies 认证"></a>Session 与 Cookies 认证</h2><h3 id="认证过程"><a href="#认证过程" class="headerlink" title="认证过程"></a>认证过程</h3><p>很多时候我们都是通过 SessionID 来实现特定的用户，SessionID 一般会选择存放在 Redis 中。举个例子：用户成功登陆系统，然后返回给客户端具有 SessionID 的 Cookie，当用户向后端发起请求的时候会把 SessionID 带上，这样后端就知道你的身份状态了。关于这种认证方式更详细的过程如下：</p>
<ol>
<li>用户向服务器发送用户名和密码用于登陆系统。</li>
<li>服务器验证通过后，服务器为用户创建一个 Session，并将 Session信息存储 起来。</li>
<li>服务器向用户返回一个 SessionID，写入用户的 Cookie。</li>
<li>当用户保持登录状态时，Cookie 将与每个后续请求一起被发送出去。</li>
<li>服务器可以将存储在 Cookie 上的 Session ID 与存储在内存中或者数据库中的 Session 信息进行比较，以验证用户的身份，返回给用户客户端响应信息的时候会附带用户当前的状态。</li>
</ol>
<p>另外，Spring Session提供了一种跨多个应用程序或实例管理用户会话信息的机制。</p>
<h3 id="Cookie-无法防止CSRF攻击"><a href="#Cookie-无法防止CSRF攻击" class="headerlink" title="Cookie 无法防止CSRF攻击"></a>Cookie 无法防止CSRF攻击</h3><p>在登陆了网银后，点击误导的超链接，导致跨服务请求成功。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">src</span>=<span class="hljs-string">http://www.mybank.com/Transfer?bankId</span>=<span class="hljs-string">11&amp;money</span>=<span class="hljs-string">10000</span>&gt;</span>科学理财，年盈利率过万<span class="hljs-tag">&lt;/&gt;</span><br></code></pre></td></tr></table></figure>

<p>进行Session 认证的时候，我们一般使用 <strong>Cookie 来存储 SessionId</strong>,当我们登陆后后端生成一个SessionId放在Cookie中返回给客户端，服务端通过Redis或者其他存储工具记录保存着这个Sessionid，客户端登录以后每次请求都会带上这个SessionId，服务端通过这个SessionId来标示你这个人。如果别人通过 cookie拿到了 SessionId 后就可以代替你的身份访问系统了。</p>
<p><img src="https://raw.githubusercontent.com/cai-qichang/cqc-photo/master/img/Cookies-attack.jpg" srcset="/img/loading.gif" lazyload alt="avatar"></p>
<p>可以使用token认证的方式避免误点攻击链接导致的跨服务请求问题。</p>
<blockquote>
<p>基于token 认证经常将认证凭证存储在local storage中，在请求的时候前端再动态添加凭证到请求中。因此误点的外部链接无法添加token到转发的请求中。</p>
</blockquote>
<h2 id="Spring-Security-对于CSRF攻击的解决方案"><a href="#Spring-Security-对于CSRF攻击的解决方案" class="headerlink" title="Spring Security 对于CSRF攻击的解决方案"></a>Spring Security 对于CSRF攻击的解决方案</h2><p>spring Security对于CSRF攻击的解决方案就是CsrfFilter。</p>
<ol>
<li>开启spring security的防csrf功能之后，对于访问后端的请求，若发现cookies中无<code>XSRF-TOKEN</code>的cookie，便会使用UUID生成一个token<code>set cookie</code>。\</li>
<li>在<code>WebSecurityConfigurerAdapter</code>的配置中，可设置Matcher对URL或只对HTTP-METHOD中POST、PATCH、DELETE等请求，进行CSRF拦截\</li>
<li>假设对POST请求进行拦截，CsrfFilter会对校验cookies中的<code>XSRF-TOKEN</code>。校验的方式为与请求头<code>X-XSRF-TOKEN</code>或参数中<code>_csrf</code>的值进行验证，如果不一致，则为CSRF攻击。<br>因此前端对于后端的请求均要把cookie中的<code>XSRF-TOKEN</code>设置到请求头或者参数中，才能通过后端的校验。<br>以上就防止的cooies认证中，对于超链接跳转的CSRF攻击。</li>
</ol>
<p>以下spring 官方提到了，使用了CORS同源策略的时候，CsrfFilter的重要性。</p>
<blockquote>
<p>It is important to keep the CsrfToken a secret from other domains. This means if you are using Cross Origin Sharing (CORS), you should NOT expose the CsrfToken to any external domains.</p>
</blockquote>
<p>** 核心逻辑可以见CsrfFilter **</p>
<h2 id="基于token认证-JWT-Bearer-Authentication"><a href="#基于token认证-JWT-Bearer-Authentication" class="headerlink" title="基于token认证 JWT (Bearer Authentication)"></a>基于token认证 JWT (Bearer Authentication)</h2><p>Json web token (JWT), 是为了在网络应用环境间传递声明而执行的一种基于JSON的开放标准（(RFC 7519).该token被设计为紧凑且安全的，特别适用于分布式站点的单点登录（SSO）场景。JWT的声明一般被用来在身份提供者和服务提供者间传递被认证的用户身份信息，以便于从资源服务器获取资源，也可以增加一些额外的其它业务逻辑所必须的声明信息，该token也可直接被用于认证，也可被加密。</p>
<p>参考资料：<a target="_blank" rel="noopener" href="https://swagger.io/docs/specification/authentication/bearer-authentication/">Bearer Authentication</a></p>
<h3 id="Session认证暴露的缺点"><a href="#Session认证暴露的缺点" class="headerlink" title="Session认证暴露的缺点"></a>Session认证暴露的缺点</h3><p>内存开销大： 每个用户经过我们的应用认证之后，我们的应用都要在服务端做一次记录，以方便用户下次请求的鉴别，通常而言session都是保存在内存中，而随着认证用户的增多，服务端的开销会明显增大。</p>
<p>分布式场景限制：在分布式的应用上，相应的限制了负载均衡器的能力。这也意味着限制了应用的扩展能力。</p>
<p>CSRF跨服务请求问题: 因为是基于cookie来进行用户识别的, cookie如果被截获，用户就会很容易受到跨站请求伪造的攻击。</p>
<h3 id="基于token-认证流程"><a href="#基于token-认证流程" class="headerlink" title="基于token 认证流程"></a>基于token 认证流程</h3><p>基于token的鉴权机制类似于http协议也是无状态的，它不需要在服务端去保留用户的认证信息或者会话信息。这就意味着基于token认证机制的应用不需要去考虑用户在哪一台服务器登录了，这就为应用的扩展提供了便利。</p>
<p>流程上是这样的：</p>
<ol>
<li>用户使用用户名密码来请求服务器</li>
<li>服务器进行验证用户的信息</li>
<li>服务器通过验证发送给用户一个token</li>
<li>客户端存储token，并在每次请求时附送上这个token值</li>
<li>服务端验证token值，并返回数据<br>这个token必须要在每次请求时传递给服务端，它应该保存在请求头里， 另外，服务端要支持CORS(跨来源资源共享)策略，一般我们在服务端这么做就可以了Access-Control-Allow-Origin: *。</li>
</ol>
<h3 id="jwt-组成"><a href="#jwt-组成" class="headerlink" title="jwt 组成"></a>jwt 组成</h3><p>JWT 由 3 部分构成:</p>
<ol>
<li>Header :描述 JWT 的元数据。定义了生成签名的算法以及 Token 的类型。</li>
<li>Payload（负载）:用来存放实际需要传递的数据</li>
<li>Signature（签名）：服务器通过Payload、Header和一个密钥(secret)使用 Header 里面指定的签名算法（默认是 HMAC SHA256）生成。</li>
</ol>
<blockquote>
<p>secret是保存在服务器端的，jwt的签发生成也是在服务器端的，secret就是用来进行jwt的签发和jwt的验证，所以，它就是你服务端的私钥，在任何场景都不应该流露出去。一旦客户端得知这个secret, 那就意味着客户端是可以自我签发jwt了。</p>
</blockquote>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">public String generate<span class="hljs-constructor">Token(String <span class="hljs-params">subject</span>)</span> &#123;<br>    return <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Jwts</span>.</span></span>builder<span class="hljs-literal">()</span><br>            <span class="hljs-comment">//  设置发行人即 签发的 APP</span><br>            .set<span class="hljs-constructor">Issuer( APP_NAME )</span><br>            <span class="hljs-comment">// 存放实际传递数据</span><br>            .set<span class="hljs-constructor">Subject(<span class="hljs-params">subject</span>)</span><br>            <span class="hljs-comment">// token 生成时间</span><br>            .set<span class="hljs-constructor">IssuedAt(<span class="hljs-params">new</span> Date()</span>)<br>            <span class="hljs-comment">// 过期时间</span><br>            .set<span class="hljs-constructor">Expiration(<span class="hljs-params">generateExpirationDate</span>()</span>)<br>            <span class="hljs-comment">// SIGNATURE_ALGORITHM加密算法    SECRET加盐字段 进行组合加密</span><br>            .sign<span class="hljs-constructor">With( SIGNATURE_ALGORITHM, SECRET )</span><br>            <span class="hljs-comment">// 生成token</span><br>            .compact<span class="hljs-literal">()</span>;<br> &#125;<br></code></pre></td></tr></table></figure>

<h3 id="总结-1"><a href="#总结-1" class="headerlink" title="总结"></a>总结</h3><p>优点</p>
<ol>
<li>因为json的通用性，所以JWT是可以进行跨语言支持的，像JAVA,JavaScript,NodeJS,PHP等很多语言都可以使用。</li>
<li>因为有了payload部分，所以JWT可以在自身存储一些其他业务逻辑所必要的非敏感信息。</li>
<li>便于传输，jwt的构成非常简单，字节占用很小，所以它是非常便于传输的。</li>
<li>它不需要在服务端保存会话信息, 所以它易于应用的扩展</li>
</ol>
<ul>
<li>安全相关</li>
</ul>
<ol>
<li>不应该在jwt的payload部分存放敏感信息，因为该部分是客户端可解密的部分。</li>
<li>保护好secret私钥，该私钥非常重要。</li>
<li>如果可以，请使用https协议</li>
</ol>
<h2 id="spring-security-JWT"><a href="#spring-security-JWT" class="headerlink" title="spring security + JWT"></a>spring security + JWT</h2><p>继承WebSecurityConfigurerAdapter类，重写config 方法，定制一些httpSecurity的规则。</p>
<blockquote>
<p>对于前后端分离的开发模式，需开放一个签发认证的url接口，而其他url接口根据业务要求，可以直接屏蔽返回未认证。</p>
</blockquote>
<p>对应JWT的集成目前主要有两种方式：</p>
<ol>
<li>继承<code>AbstractAuthenticationProcessingFilter</code>，使用认证章节中的流程。通过filter返回具体的<code>Authentication</code>对象，由有<code>Provider</code>进行认证逻辑处理</li>
<li>继承<code>OncePerRequestFilter</code>，进行认证逻辑完成后，手工设置<code>SpringSecurityHolder</code>中的认证为成功</li>
</ol>
<p>参考资料：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://www.toptal.com/spring/spring-security-tutorial">Spring Security with JWT for REST API</a></li>
<li><a target="_blank" rel="noopener" href="https://www.linkedin.com/pulse/using-json-web-tokensjwt-spring-boot-security-turkmen-mustafa-demirci">Using JSON Web Tokens(JWT) with Spring Boot Security</a></li>
</ul>
<h3 id="继承WebSecurityConfigurerAdapter"><a href="#继承WebSecurityConfigurerAdapter" class="headerlink" title="继承WebSecurityConfigurerAdapter"></a>继承WebSecurityConfigurerAdapter</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@EnableWebSecurity</span><br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WebSecurityConfigurer</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">WebSecurityConfigurerAdapter</span> &#123;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">configure</span><span class="hljs-params">(HttpSecurity http)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        http<br>        <span class="hljs-comment">// 设置从不创建session，正常基于jwt认证才会如此设置</span><br>        .sessionManagement().sessionCreationPolicy( SessionCreationPolicy.STATELESS ).and()<br>        <span class="hljs-comment">// 设置异常处理返回</span><br>        .exceptionHandling().authenticationEntryPoint( restAuthenticationEntryPoint ).and()<br>        <span class="hljs-comment">// 设置不拦截的url请求</span><br>        .authorizeRequests()<br>        .antMatchers(<span class="hljs-string">&quot;/api/v1/admin/login/**&quot;</span>).permitAll();<br>        <br>        http.authorizeRequests()<br>            .anyRequest().authenticated().and()<br>            <span class="hljs-comment">// 添加拦截器</span><br>            .addFilterBefore(tokenAuthenticationFilter, BasicAuthenticationFilter.class);<br>        <span class="hljs-comment">// 禁止跨服务请求</span><br>        http.csrf().disable();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="基于AbstractAuthenticationProcessingFilter"><a href="#基于AbstractAuthenticationProcessingFilter" class="headerlink" title="基于AbstractAuthenticationProcessingFilter"></a>基于AbstractAuthenticationProcessingFilter</h3><h4 id="WebSecurityConfigurerAdapter的配置demo"><a href="#WebSecurityConfigurerAdapter的配置demo" class="headerlink" title="WebSecurityConfigurerAdapter的配置demo"></a>WebSecurityConfigurerAdapter的配置demo</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Slf4j</span><br><span class="hljs-meta">@Configuration</span><br><span class="hljs-meta">@EnableWebSecurity</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserWebSecurityConfig</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">WebSecurityConfigurerAdapter</span> &#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> JwtAuthenticationProvider jwtAuthenticationProvider;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> JwtRefreshAuthenticationProvider jwtRefreshAuthenticationProvider;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> PermissionProperty PermissionProperty;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> IJwtTokenService jwtTokenService;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">configure</span><span class="hljs-params">(HttpSecurity http)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>       <span class="hljs-comment">// 设置从不创建session，正常基于jwt认证才会如此设置</span><br>        http.sessionManagement().sessionCreationPolicy(SessionCreationPolicy.STATELESS).and();<br>        <span class="hljs-comment">// 设置读取配置的permitAll 以及允许所有接口使用OPTIONS</span><br>        http.authorizeRequests().antMatchers(resolvePermitAll()).permitAll()<br>                .and().authorizeRequests().antMatchers(HttpMethod.OPTIONS).permitAll()<br>                <span class="hljs-comment">// 添加自定义的Authentication过滤器</span><br>                .and().addFilterAt(jwtAuthenticationFilter(), UsernamePasswordAuthenticationFilter.class)<br>              <span class="hljs-comment">// 设置异常处理返回，主要用于处理AccessDeny的异常</span><br>              .exceptionHandling().authenticationEntryPoint( restAuthenticationEntryPoint );<br>        <br><br>       <span class="hljs-comment">// 开启同源认证CORS过滤器</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">contentSecurityPolicyStyleSrc</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;style-src &#x27;self&#x27; &quot;</span> + String.join(<span class="hljs-string">&quot; &quot;</span>, securityProperty.getCsp().getStyleSrc());<br>        <span class="hljs-type">String</span> <span class="hljs-variable">contentSecurityPolicyScriptSrc</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;script-src &#x27;self&#x27; &quot;</span>+ String.join(<span class="hljs-string">&quot; &quot;</span>, securityProperty.getCsp().getScriptSrc());<br>        http.cors().configurationSource(corsConfigurationSource())<br>                .and().headers()<br>                .frameOptions().deny()<br>                .contentTypeOptions()<br>                .and().xssProtection()<br>                .and().cacheControl()<br>                .and().httpStrictTransportSecurity()<br>                .and().addHeaderWriter(<span class="hljs-keyword">new</span> <span class="hljs-title class_">StaticHeadersWriter</span>(<span class="hljs-string">&quot;Content-Security-Policy&quot;</span>, contentSecurityPolicyStyleSrc, contentSecurityPolicyScriptSrc));<br><br>        http.csrf().csrfTokenRepository(cookieCsrfTokenRepository)<br>                .requireCsrfProtectionMatcher(createRequireCsrfProtectionMatcher());<br>    &#125;<br><br>   <span class="hljs-comment">/**</span><br><span class="hljs-comment">    * 基于认证的provider</span><br><span class="hljs-comment">    * <span class="hljs-doctag">@param</span> auth</span><br><span class="hljs-comment">    */</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">configure</span><span class="hljs-params">(AuthenticationManagerBuilder auth)</span> &#123;<br>        auth.authenticationProvider(jwtAuthenticationProvider);<br>        auth.authenticationProvider(jwtRefreshAuthenticationProvider);<br>    &#125;<br><br>   <span class="hljs-comment">/**</span><br><span class="hljs-comment">    * 设置自己自定义的JwtAuthenticationFilter</span><br><span class="hljs-comment">    * 注意要再matcher中指定拦截的范围</span><br><span class="hljs-comment">    * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">    * <span class="hljs-doctag">@throws</span> Exception</span><br><span class="hljs-comment">    */</span><br>    <span class="hljs-keyword">private</span> JwtAuthenticationFilter <span class="hljs-title function_">jwtAuthenticationFilter</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        List&lt;RequestMatcher&gt; matchers = Lists.newArrayList();<br>        <span class="hljs-keyword">for</span> (String pattern : resolvePermitAll()) &#123;<br>            matchers.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">AntPathRequestMatcher</span>(pattern, <span class="hljs-literal">null</span>));<br>        &#125;<br>        <span class="hljs-type">JwtAuthenticationFilter</span> <span class="hljs-variable">jwtAuthenticationFilter</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JwtAuthenticationFilter</span>(<br>                request -&gt; matchers.stream().noneMatch(matcher -&gt; matcher.matches(request))<br>        );<br>        jwtAuthenticationFilter.setAuthenticationManager(authenticationManager());<br>        <span class="hljs-comment">// 认证失败及成功处理器</span><br>        jwtAuthenticationFilter.setAuthenticationFailureHandler(createAuthenticationFailureHandler());<br>        jwtAuthenticationFilter.setAuthenticationSuccessHandler(createAuthenticationSuccessHandler());<br>        <span class="hljs-keyword">return</span> jwtAuthenticationFilter;<br>    &#125;<br>    <br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 同源处理器，自定义设置允许传输的请求头字段</span><br><span class="hljs-comment">     * 允许跨域的地址等等</span><br><span class="hljs-comment">    */</span><br>    <span class="hljs-keyword">private</span> CorsConfigurationSource <span class="hljs-title function_">corsConfigurationSource</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">CorsConfiguration</span> <span class="hljs-variable">config</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CorsConfiguration</span>();<br>        config.setAllowCredentials(<span class="hljs-literal">true</span>);<br>        config.setAllowedHeaders(Lists.newArrayList(<span class="hljs-string">&quot;Origin&quot;</span>, <span class="hljs-string">&quot;Content-Type&quot;</span>, <span class="hljs-string">&quot;Accept&quot;</span>, <span class="hljs-string">&quot;X-Flow-Id&quot;</span>));<br>        config.setExposedHeaders(Lists.newArrayList(<span class="hljs-string">&quot;Content-Type&quot;</span>, <span class="hljs-string">&quot;X-TenantID&quot;</span>, <span class="hljs-string">&quot;X-Track-Id&quot;</span>));<br>        config.setAllowedOrigins(Lists.newArrayList(securityProperty.getCors().getAllowOrigins()));<br>        config.setAllowedMethods(Lists.newArrayList(HttpMethod.OPTIONS.name(), HttpMethod.GET.name(), HttpMethod.POST.name()));<br>        <span class="hljs-type">UrlBasedCorsConfigurationSource</span> <span class="hljs-variable">source</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UrlBasedCorsConfigurationSource</span>();<br>        source.registerCorsConfiguration(<span class="hljs-string">&quot;/**&quot;</span>, config);<br>        <span class="hljs-keyword">return</span> source;<br>    &#125;<br><br>   <span class="hljs-comment">/**</span><br><span class="hljs-comment">    * 从配置中读取</span><br><span class="hljs-comment">    * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">    */</span><br>    <span class="hljs-keyword">private</span> String[] resolvePermitAll() &#123;<br>         <span class="hljs-keyword">return</span> securityJwtProperty.getPermitAll();<br>    &#125;<br><br>   <span class="hljs-comment">/**</span><br><span class="hljs-comment">    * 设置csrftoken的过滤</span><br><span class="hljs-comment">    * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">    */</span><br>    <span class="hljs-keyword">private</span> RequestMatcher <span class="hljs-title function_">createRequireCsrfProtectionMatcher</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RequestMatcher</span>() &#123;<br>            <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">AntPathMatcher</span> <span class="hljs-variable">antPathMatcher</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AntPathMatcher</span>();<br><br>            <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> HashSet&lt;String&gt; allowedMethods = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashSet</span>&lt;&gt;(<br>                    Arrays.asList(<span class="hljs-string">&quot;GET&quot;</span>, <span class="hljs-string">&quot;HEAD&quot;</span>, <span class="hljs-string">&quot;TRACE&quot;</span>, <span class="hljs-string">&quot;OPTIONS&quot;</span>));<br><br>            <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">matches</span><span class="hljs-params">(HttpServletRequest request)</span> &#123;<br>                <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.allowedMethods.contains(request.getMethod())) &#123;<br>                    log.debug(<span class="hljs-string">&quot;CSRF disabled of methods &#123;&#125; match&quot;</span>, request.getRequestURI());<br>                    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>                &#125;<br>                <span class="hljs-keyword">if</span> (!StringUtils.isEmpty(request.getHeader(<span class="hljs-string">&quot;Authorization&quot;</span>))) &#123;<br>                    log.debug(<span class="hljs-string">&quot;CSRF disabled matched header Authorization, requestURI: &#123;&#125;&quot;</span>, request.getRequestURI());<br>                    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>                &#125;<br>                <span class="hljs-keyword">return</span> Stream.concat(Stream.of(securityJwtProperty.getPermitAll()), Stream.of(securityJwtProperty.getSwaggerPermitAll()))<br>                        .noneMatch(pattern -&gt; <span class="hljs-built_in">this</span>.antPathMatcher.match(pattern, request.getRequestURI()));<br>            &#125;<br>        &#125;;<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<h4 id="JWTAuthenticationFilter"><a href="#JWTAuthenticationFilter" class="headerlink" title="JWTAuthenticationFilter"></a>JWTAuthenticationFilter</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Slf4j</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">JwtAuthenticationFilter</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractAuthenticationProcessingFilter</span> &#123;<br><br>    <span class="hljs-keyword">private</span> IJwtTokenService jwtTokenService;<br><br>   <span class="hljs-comment">/**</span><br><span class="hljs-comment">    *  拦截对应的的JWTHeader 递交给对应的Providr</span><br><span class="hljs-comment">    * <span class="hljs-doctag">@param</span> request</span><br><span class="hljs-comment">    * <span class="hljs-doctag">@param</span> response</span><br><span class="hljs-comment">    * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">    */</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> Authentication <span class="hljs-title function_">attemptAuthentication</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="hljs-keyword">throws</span> AuthenticationException &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">authorization</span> <span class="hljs-operator">=</span> request.getHeader(AuthorizationHeader);<br>        <span class="hljs-keyword">if</span> (!Strings.isNullOrEmpty(authorization) &amp;&amp; authorization.startsWith(<span class="hljs-string">&quot;bearer &quot;</span>)) &#123;<br>            <span class="hljs-keyword">return</span> attemptHeaderAuthentication(request, authorization);<br>        &#125;<br>        <span class="hljs-keyword">if</span> (request.getCookies() == <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JwtAuthenticationException</span>(String.format(<span class="hljs-string">&quot;Jwt cookies are absent, request api is [%s]&quot;</span>, request.getServletPath()));<br>        &#125;<br>       <span class="hljs-type">String</span> <span class="hljs-variable">jwt</span> <span class="hljs-operator">=</span> authorization.substring(<span class="hljs-number">7</span>);<br>       String[] jwtSplits = jwt.split(<span class="hljs-string">&quot;\\.&quot;</span>);<br>       <span class="hljs-keyword">if</span> (jwtSplits.length != <span class="hljs-number">3</span>) &#123;<br>          log.error(<span class="hljs-string">&quot;Jwt is in wrong format, request api is &#123;&#125;&quot;</span>, request.getServletPath());<br>          <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JwtAuthenticationException</span>(String.format(<span class="hljs-string">&quot;Jwt is in wrong format, request api is [%s]&quot;</span>, request.getServletPath()));<br>       &#125;<br>       <span class="hljs-type">JwtAuthenticationToken</span> <span class="hljs-variable">jwtToken</span> <span class="hljs-operator">=</span> jwtTokenService.digestJwtToken(jwt);<br>       jwtToken.setAgentContext(agentContext);<br>       <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.getAuthenticationManager().authenticate(jwtToken);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">successfulAuthentication</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response, FilterChain chain, Authentication authResult)</span> <span class="hljs-keyword">throws</span> IOException, ServletException &#123;<br>        <span class="hljs-built_in">super</span>.successfulAuthentication(request, response, chain, authResult);<br>        chain.doFilter(request, response);<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<h4 id="JwtAuthenticationProvider"><a href="#JwtAuthenticationProvider" class="headerlink" title="JwtAuthenticationProvider"></a>JwtAuthenticationProvider</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Slf4j</span><br><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">JwtAuthenticationProvider</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">AuthenticationProvider</span> &#123;<br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> BlacklistService blacklistService;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> UserPermissionClient userPermissionClient;<br><br>   <span class="hljs-comment">/**</span><br><span class="hljs-comment">    * 执行认证逻辑</span><br><span class="hljs-comment">    * <span class="hljs-doctag">@param</span> authentication</span><br><span class="hljs-comment">    * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">    * <span class="hljs-doctag">@throws</span> AuthenticationException</span><br><span class="hljs-comment">    */</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> Authentication <span class="hljs-title function_">authenticate</span><span class="hljs-params">(Authentication authentication)</span> <span class="hljs-keyword">throws</span> AuthenticationException &#123;<br>        <span class="hljs-type">JwtAuthenticationToken</span> <span class="hljs-variable">jwtToken</span> <span class="hljs-operator">=</span> (JwtAuthenticationToken) authentication;<br>        <span class="hljs-comment">// ....</span><br>        jwtToken.setAuthenticated(<span class="hljs-literal">true</span>);<br>        <span class="hljs-keyword">return</span> jwtToken;<br>    &#125;<br><br>   <span class="hljs-comment">/**</span><br><span class="hljs-comment">    * 设置支持认证何种类型的Authentication</span><br><span class="hljs-comment">    * <span class="hljs-doctag">@param</span> authentication</span><br><span class="hljs-comment">    * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">    */</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">supports</span><span class="hljs-params">(Class&lt;?&gt; authentication)</span> &#123;<br>        <span class="hljs-keyword">return</span> authentication.isAssignableFrom(JwtAuthenticationToken.class);<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<h3 id="基于OncePerRequestFilter"><a href="#基于OncePerRequestFilter" class="headerlink" title="基于OncePerRequestFilter"></a>基于OncePerRequestFilter</h3><h4 id="WebSecurityConfigurer"><a href="#WebSecurityConfigurer" class="headerlink" title="WebSecurityConfigurer"></a>WebSecurityConfigurer</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Configuration</span><br><span class="hljs-meta">@EnableWebSecurity</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WebSecurityConfigurer</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">WebSecurityConfigurerAdapter</span> &#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> RestAuthenticationEntryPoint restAuthenticationEntryPoint;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> TokenAuthenticationFilter tokenAuthenticationFilter;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">configure</span><span class="hljs-params">(HttpSecurity http)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        http<br>            .sessionManagement().sessionCreationPolicy( SessionCreationPolicy.STATELESS ).and()<br>            .exceptionHandling().authenticationEntryPoint( restAuthenticationEntryPoint ).and()<br>            .authorizeRequests()<br>            .antMatchers(<span class="hljs-string">&quot;/api/v1/admin/login/**&quot;</span>).permitAll()<br>            .antMatchers(<span class="hljs-string">&quot;/upload/**&quot;</span>).permitAll();<br><br><br>        <span class="hljs-comment">// API权限控制</span><br>        ExpressionUrlAuthorizationConfigurer&lt;HttpSecurity&gt;.<span class="hljs-type">ExpressionInterceptUrlRegistry</span> <span class="hljs-variable">urlRegistry</span> <span class="hljs-operator">=</span> http.authorizeRequests();<br>        Map&lt;String, String&gt; resourcePermissions = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>        <span class="hljs-keyword">for</span> (Map.Entry&lt;String, String&gt; entry : resourcePermissions.entrySet()) &#123;<br>            urlRegistry = urlRegistry.antMatchers(entry.getKey()).hasAnyAuthority(entry.getValue());<br>        &#125;<br><br>        http.authorizeRequests()<br>            .anyRequest().authenticated().and()<br>                <span class="hljs-comment">// 在默认的BasicAuthenticationFilter前添加自定义的过滤器</span><br>            .addFilterBefore(tokenAuthenticationFilter, BasicAuthenticationFilter.class);<br><br>        http.csrf().disable();<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">configure</span><span class="hljs-params">(WebSecurity web)</span> &#123;<br>        web.ignoring().antMatchers(<br>                HttpMethod.POST,<br>                <span class="hljs-string">&quot;/api/v1/admin/login/toLogin&quot;</span><br>        ).antMatchers(<br>                HttpMethod.POST,<br>                <span class="hljs-string">&quot;/api/v1/front/wxAuthor/**&quot;</span><br>        ).antMatchers(<br>                HttpMethod.POST,<br>                <span class="hljs-string">&quot;/api/v1/admin/wxAuthor/**&quot;</span><br>        ).antMatchers(<br>                HttpMethod.POST,<br>                <span class="hljs-string">&quot;/api/v1/front/wxMessage/**&quot;</span><br>        ).antMatchers(<br>                HttpMethod.GET,<br>                <span class="hljs-string">&quot;/static/**&quot;</span><br>        ).antMatchers(<br>                HttpMethod.GET,<br>                <span class="hljs-string">&quot;/upload/**&quot;</span><br>        );<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="JwtTokenAuthenticationFilter"><a href="#JwtTokenAuthenticationFilter" class="headerlink" title="JwtTokenAuthenticationFilter"></a>JwtTokenAuthenticationFilter</h4><p><strong>注意在</strong><code>SecurityContextHolder.getContext().setAuthentication(authentication);</code> 设置认证成功的authentication，Spring security就会认为已经认证成功</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TokenAuthenticationFilter</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">OncePerRequestFilter</span> &#123;<br><br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> TokenHelper tokenHelper;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doFilterInternal</span><span class="hljs-params">(</span><br><span class="hljs-params">            HttpServletRequest request,</span><br><span class="hljs-params">            HttpServletResponse response,</span><br><span class="hljs-params">            FilterChain chain</span><br><span class="hljs-params">    )</span> <span class="hljs-keyword">throws</span> IOException, ServletException &#123;<br><br>        String userInfo;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">authToken</span> <span class="hljs-operator">=</span> tokenHelper.getToken(request);<br><br>        <span class="hljs-keyword">if</span> (authToken != <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-comment">// get username from token</span><br>            userInfo = tokenHelper.getUserInfoFromToken(authToken);<br>            System.out.println(userInfo);<br>            <span class="hljs-keyword">if</span> (userInfo != <span class="hljs-literal">null</span>) &#123;<br>                <span class="hljs-keyword">if</span> (tokenHelper.validateToken(authToken)) &#123;<br>                    String[] userInfos = userInfo.split(<span class="hljs-string">&quot;~&quot;</span>);<br><br>                    <span class="hljs-type">String</span> <span class="hljs-variable">userName</span> <span class="hljs-operator">=</span> userInfos[<span class="hljs-number">0</span>];<br>                    List&lt;GrantedAuthority&gt; authorities = buildAuthorities(userName);<br>                    <span class="hljs-type">TokenBasedAuthentication</span> <span class="hljs-variable">authentication</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TokenBasedAuthentication</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">AccountCredentials</span>(userName, authorities));<br>                    authentication.setToken(authToken);<br>                    authentication.setAuthenticated(<span class="hljs-literal">true</span>);<br>                    SecurityContextHolder.getContext().setAuthentication(authentication);<br>                &#125;<br>            &#125;<br>        &#125;<br>        chain.doFilter(request, response);<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> List&lt;GrantedAuthority&gt; <span class="hljs-title function_">buildAuthorities</span><span class="hljs-params">(String userName)</span> &#123;<br>        List&lt;String&gt; permissionNames = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>        List&lt;GrantedAuthority&gt; authorities = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>        <span class="hljs-keyword">for</span> (String permissionName : permissionNames) &#123;<br>            <span class="hljs-type">GrantedAuthority</span> <span class="hljs-variable">authority</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PermissionGrantedAuthority</span>(permissionName);<br>            authorities.add(authority);<br>        &#125;<br><br>        <span class="hljs-keyword">return</span> authorities;<br>    &#125;<br><br>&#125;<br><br></code></pre></td></tr></table></figure>

<h3 id="登陆接口：验证用户名密码签发token"><a href="#登陆接口：验证用户名密码签发token" class="headerlink" title="登陆接口：验证用户名密码签发token"></a>登陆接口：验证用户名密码签发token</h3><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-meta">@GetMapping</span><br><span class="hljs-keyword">private</span> <span class="hljs-title class_">String</span> <span class="hljs-title function_">toLogin</span>(<span class="hljs-params">HttpServletRequest request, <span class="hljs-built_in">String</span> username, <span class="hljs-built_in">String</span> password</span>) &#123;<br>    <span class="hljs-comment">// 登录成功</span><br>    <span class="hljs-keyword">if</span> (password.<span class="hljs-title function_">equals</span>(<span class="hljs-string">&quot;112233&quot;</span>)) &#123;<br>        <span class="hljs-title class_">String</span> token = tokenHelper.<span class="hljs-title function_">generateToken</span>(username+<span class="hljs-string">&quot;~role&quot;</span>);<br>        <span class="hljs-comment">// 登陆成功</span><br>        <span class="hljs-keyword">return</span> token;<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;认证失败&quot;</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="权限问题"><a href="#权限问题" class="headerlink" title="权限问题"></a>权限问题</h3><p>spring的权限体系结构：<br><img src="https://docs.spring.io/spring-security/site/docs/current/reference/html5/images/servlet/authorization/filtersecurityinterceptor.png" srcset="/img/loading.gif" lazyload alt="image"></p>
<p><img src="https://raw.githubusercontent.com/cai-qichang/cqc-photo/master/img/0a6b437fe2034d44a393998ef4bf173a.png" srcset="/img/loading.gif" lazyload alt="在这里插入图片描述"></p>
<p>一、使用默认的spring security 需要继承GrantedAuthority，返回用于认证的getAuthority()</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PermissionGrantedAuthority</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">GrantedAuthority</span> &#123;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String permission;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">PermissionGrantedAuthority</span><span class="hljs-params">(String permission)</span> &#123;<br>        Assert.hasText(permission, <span class="hljs-string">&quot;A granted authority textual representation is required&quot;</span>);<br>        <span class="hljs-built_in">this</span>.permission = permission;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getAuthority</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> permission;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>二、 在用户成功认证完成之后，需要将用户对应的权限赋予用户</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TokenAuthenticationProvider</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">AuthenticationProvider</span> &#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> ITokenAuthenticationService tokenAuthenticationService;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> Authentication <span class="hljs-title function_">authenticate</span><span class="hljs-params">(Authentication authentication)</span> <span class="hljs-keyword">throws</span> AuthenticationException &#123;<br>        <span class="hljs-type">BaseTokenAuthentication</span> <span class="hljs-variable">baseTokenAuthentication</span> <span class="hljs-operator">=</span> (BaseTokenAuthentication)authentication;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">token</span> <span class="hljs-operator">=</span> baseTokenAuthentication.getToken();<br>        <span class="hljs-type">String</span> <span class="hljs-variable">userInfoFromToken</span> <span class="hljs-operator">=</span> jwtTokenHelper.getUserInfoFromToken(token);<br>        log.info(<span class="hljs-string">&quot;authenticate success userInfo:&#123;&#125;&quot;</span>, userInfoFromToken);<br>        <span class="hljs-type">BaseTokenAuthentication</span> <span class="hljs-variable">authentication</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BaseTokenAuthentication</span>(token, createRole());<br>        authentication.setAuthenticated(<span class="hljs-literal">true</span>);<br>        <span class="hljs-keyword">return</span> authentication;<br>    &#125;<br>    <br>    <span class="hljs-comment">// 此处只是简单的模拟该用户有 ADMIN权限</span><br>    <span class="hljs-keyword">private</span> List&lt;? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">GrantedAuthority</span>&gt; createRole() &#123;<br>        <span class="hljs-keyword">return</span> Arrays.asList(<span class="hljs-keyword">new</span> <span class="hljs-title class_">PermissionGrantedAuthority</span>(<span class="hljs-string">&quot;ROLE_ADMIN&quot;</span>));<br>    &#125;<br><br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">supports</span><span class="hljs-params">(Class&lt;?&gt; authentication)</span> &#123;<br>        <span class="hljs-keyword">return</span> authentication.isAssignableFrom(BaseTokenAuthentication.class);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>三、 配置url对应的权限</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Configuration</span><br><span class="hljs-meta">@EnableWebSecurity</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BaseWebSecurityConfig</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">WebSecurityConfigurerAdapter</span> &#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> PermissionProperty permissionProperty;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">configure</span><span class="hljs-params">(WebSecurity web)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-built_in">super</span>.configure(web);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">configure</span><span class="hljs-params">(HttpSecurity http)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        http.sessionManagement().sessionCreationPolicy(SessionCreationPolicy.STATELESS).and()<br>        <span class="hljs-comment">// ...</span><br>    <br>        <span class="hljs-comment">// application中配置 url跟role的键值对，设置到authorize中</span><br>        http.authorizeRequests(authorize -&gt; &#123;<br>            permissionProperty.getPermissionList().forEach(model -&gt; &#123;<br>                authorize.mvcMatchers(model.getUrl()).hasAnyRole(model.getRole());<br>            &#125;);<br>            authorize.anyRequest().denyAll();<br>        &#125;);<br><br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>


<h2 id="JWT-token-常见问题"><a href="#JWT-token-常见问题" class="headerlink" title="JWT token 常见问题"></a>JWT token 常见问题</h2><h3 id="注销登录等场景下-token-处理"><a href="#注销登录等场景下-token-处理" class="headerlink" title="注销登录等场景下 token 处理"></a>注销登录等场景下 token 处理</h3><p>需要处理token的场景：</p>
<ol>
<li>退出登录;</li>
<li>修改密码;</li>
<li>服务端修改了某个用户具有的权限或者角色；</li>
<li>用户的帐户被删除&#x2F;暂停。</li>
<li>用户由管理员注销；</li>
</ol>
<p>解决方案：</p>
<ol>
<li>存储黑名单token，如redis + token过期时间存储黑名单。<ul>
<li>redis的数据结构可以使用string + 过期时间，把token 当key，value使用状态表示。</li>
<li>redis 使用zset，使用过期时间当score，value为jwt token, 使用zrangeByscore 过滤是否还存在过期key, zrank key member 获取元素是否存在。</li>
</ul>
</li>
<li>设置较短的token过期时间，但是会导致用户频繁登陆，体验不好。</li>
</ol>
<h3 id="过期token-的续签问题"><a href="#过期token-的续签问题" class="headerlink" title="过期token 的续签问题"></a>过期token 的续签问题</h3><ol>
<li>token有效期延长。适合安全度不高的系统。</li>
<li>用户登录返回两个 token。一个用于登陆一个用于续签。<ul>
<li>一个是 accessToken ，它的过期时间 token 本身的过期时间比如半个小时</li>
<li>一个是 refreshToken 它的过期时间更长一点比如为1天。</li>
</ul>
</li>
</ol>
<blockquote>
<p>该方案的不足是：</p>
<ol>
<li>需要客户端来配合； </li>
<li>用户注销的时候需要同时保证两个 token 都无效；</li>
<li>重新请求获取 token 的过程中会有短暂 token 不可用的情况（可以通过在客户端设置定时器，当accessToken 快过期的时候，提前去通过 refreshToken 获取新的accessToken）。</li>
</ol>
</blockquote>
<h2 id="跨源资源共享（CORS）"><a href="#跨源资源共享（CORS）" class="headerlink" title="跨源资源共享（CORS）"></a>跨源资源共享（CORS）</h2><p>跨源资源共享 (CORS) （或通俗地译为跨域资源共享）是一种基于HTTP 头的机制，该机制通过允许服务器标示除了它自己以外的其它origin（域，协议和端口），这样浏览器可以访问加载这些资源。</p>
<blockquote>
<p>跨源域资源共享（ CORS ）机制允许 Web 应用服务器进行跨源访问控制，从而使跨源数据传输得以安全进行。作用与JSONP类似</p>
</blockquote>
<p>具体Spring security中的配置可以见下文</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@EnableWebSecurity</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WebSecurityConfig</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">WebSecurityConfigurerAdapter</span> &#123;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">configure</span><span class="hljs-params">(HttpSecurity http)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        http<br>            <span class="hljs-comment">// by default uses a Bean by the name of corsConfigurationSource</span><br>            .cors(withDefaults());<br>            <span class="hljs-comment">// ...</span><br>    &#125;<br><br>    <span class="hljs-meta">@Bean</span><br>    CorsConfigurationSource <span class="hljs-title function_">corsConfigurationSource</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">CorsConfiguration</span> <span class="hljs-variable">configuration</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CorsConfiguration</span>();<br>        configuration.setAllowedOrigins(Arrays.asList(<span class="hljs-string">&quot;https://example.com&quot;</span>));<br>        configuration.setAllowedMethods(Arrays.asList(<span class="hljs-string">&quot;GET&quot;</span>,<span class="hljs-string">&quot;POST&quot;</span>));<br>        <span class="hljs-type">UrlBasedCorsConfigurationSource</span> <span class="hljs-variable">source</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UrlBasedCorsConfigurationSource</span>();<br>        source.registerCorsConfiguration(<span class="hljs-string">&quot;/**&quot;</span>, configuration);<br>        <span class="hljs-keyword">return</span> source;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="相关资料"><a href="#相关资料" class="headerlink" title="相关资料"></a>相关资料</h2><ul>
<li><a target="_blank" rel="noopener" href="https://github.com/Snailclimb/JavaGuide/blob/master/docs/system-design/authority-certification/basis-of-authority-certification.md">认证基础知识</a></li>
<li><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/576dbf44b2ae">jwt认证</a></li>
</ul>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/Spring/" class="category-chain-item">Spring</a>
  
  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/Spring-Security/" class="print-no-link">#Spring Security</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>Spring Security</div>
      <div>https://cai-qichang.github.io/2023/04/02/Spring-Security/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>作者</div>
          <div>caiqichang</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>发布于</div>
          <div>2023年4月2日</div>
        </div>
      
      
      
        <div class="license-meta-item">
          <div>许可协议</div>
          <div>
            
              BY-蔡奇倡
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2023/04/05/Spring-Sharding-JDBC/" title="Spring Sharding-JDBC">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">Spring Sharding-JDBC</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2023/03/25/Spring-Boot%E5%8A%A0%E8%BD%BD%E6%B5%81%E7%A8%8B/" title="Spring Boot加载流程">
                        <span class="hidden-mobile">Spring Boot加载流程</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>目录</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
    <div class="statistics">
  
  

  
    
      <span id="busuanzi_container_site_pv" style="display: none">
        总访问量 
        <span id="busuanzi_value_site_pv"></span>
         次
      </span>
    
    
      <span id="busuanzi_container_site_uv" style="display: none">
        总访客数 
        <span id="busuanzi_value_site_uv"></span>
         人
      </span>
    
    
  
</div>

  
  
    <!-- 备案信息 ICP for China -->
    <div class="beian">
  <span>
    <a href="http://beian.miit.gov.cn/" target="_blank" rel="nofollow noopener">
      粤ICP备2021019144号
    </a>
  </span>
  
</div>

  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.4/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.20.1/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script  src="/js/local-search.js" ></script>

  <script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
</body>
</html>
